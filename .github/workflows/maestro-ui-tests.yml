name: Maestro UI Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run (smoke, all, etc.)'
        required: false
        default: 'smoke'

jobs:
  maestro_tests:
    name: Run Maestro UI Tests
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Verify Maestro installation
        run: maestro --version

      - name: Build FilePilot app
        run: |
          xcodebuild -scheme FilePilot \
            -configuration Debug \
            -sdk macosx \
            -derivedDataPath build/macos \
            build

      - name: Start observability backend (optional)
        run: |
          # Start TypeScript server in background for telemetry
          cd agentic-workflow
          bun install
          bun run dev > ../server.log 2>&1 &
          sleep 10
          curl -f http://localhost:3000/health || echo "Server not ready (telemetry will be skipped)"
        continue-on-error: true

      - name: Run Maestro tests
        id: maestro_tests
        env:
          TRACE_ID: ${{ github.run_id }}
          TELEMETRY_ENDPOINT: http://localhost:3000/api/maestro/telemetry
        run: |
          TEST_SUITE="${{ github.event.inputs.test_suite || 'smoke' }}"
          ./scripts/maestro/run-maestro-tests.sh "$TEST_SUITE"
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-test-results
          path: |
            .build/maestro-results/
            .maestro/screenshots/

      - name: Upload Maestro logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-logs
          path: .build/maestro-results/*.log

      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read test results (if available)
            let comment = '## ðŸ§ª Maestro UI Test Results\n\n';

            try {
              const files = fs.readdirSync('.build/maestro-results');
              const resultFiles = files.filter(f => f.endsWith('_result.xml'));

              comment += `**Tests Run:** ${resultFiles.length}\n`;
              comment += `**Trace ID:** ${{ github.run_id }}\n\n`;

              // Parse basic pass/fail (simplified)
              let passed = 0;
              let failed = 0;

              resultFiles.forEach(file => {
                const content = fs.readFileSync(`.build/maestro-results/${file}`, 'utf8');
                if (content.includes('failures="0"')) {
                  passed++;
                } else {
                  failed++;
                }
              });

              comment += `âœ… **Passed:** ${passed}\n`;
              comment += `âŒ **Failed:** ${failed}\n\n`;

              if (failed > 0) {
                comment += '### Failed Tests\n\n';
                // Add links to artifacts
                comment += `View detailed results and screenshots in the [artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).\n`;
              }

            } catch (error) {
              comment += `Unable to parse test results: ${error.message}\n`;
            }

            // Post comment
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Fail if tests failed
        if: steps.maestro_tests.outcome == 'failure'
        run: exit 1

  # Optional: Run on Maestro Cloud for real device testing
  maestro_cloud:
    name: Run on Maestro Cloud
    runs-on: macos-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build FilePilot app
        run: |
          xcodebuild -scheme FilePilot \
            -configuration Release \
            -sdk macosx \
            -derivedDataPath build/macos \
            archive

      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Upload to Maestro Cloud
        env:
          MAESTRO_CLOUD_API_KEY: ${{ secrets.MAESTRO_CLOUD_API_KEY }}
        run: |
          # Upload flows to Maestro Cloud (requires API key)
          maestro cloud --apiKey=$MAESTRO_CLOUD_API_KEY \
            .maestro/flows/
        continue-on-error: true
