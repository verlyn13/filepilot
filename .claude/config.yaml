# Claude Code CLI Configuration
# This configuration makes the agent aware of our project structure and observability
# Modern Workflow: XcodeGen + mise (November 2025)

version: "1.1"
workflow_version: "modern-2025"
last_updated: "2025-11-04"

project:
  name: "FilePilot + Agentic Workflow"
  type: "integrated-development"
  description: "Swift macOS file manager with TypeScript observability and AI-assisted development"
  build_system: "xcodegen"  # Project as Code
  task_runner: "mise"       # Task automation

# Primary documentation sources (single source of truth)
documentation:
  index: "./DOCUMENTATION_INDEX.md"
  schemas:
    - "./docs/schemas/documentation.schema.json"
    - "./docs/schemas/api.schema.json"
    - "./docs/schemas/observability.schema.json"
  observability_guide: "./agentic-workflow/docs/OBSERVABILITY.md"
  startup_guide: "./.claude/STARTUP_GUIDE.md"  # REQUIRED READING before any development
  validation:
    enabled: true
    on_commit: true
    on_agent_access: true

# Development cycle integration
development:
  cycle:
    - name: "planning"
      docs: ["./plan.md", "./INTEGRATED_PLAN.md"]
      tools: ["Task", "TodoWrite"]
    - name: "implementation"
      docs: ["./agentic-workflow/docs/DEVELOPMENT_PRINCIPLES.md"]
      tools: ["Edit", "Write", "Read"]
    - name: "testing"
      docs: ["./agentic-workflow/docs/API.md"]
      tools: ["Bash", "Task"]
    - name: "monitoring"
      docs: ["./agentic-workflow/README.md"]
      tools: ["BashOutput", "WebFetch"]

# Observability configuration
observability:
  typescript_backend:
    endpoint: "http://localhost:3000"
    telemetry_path: "/api/telemetry"
    metrics_path: "/metrics"
    health_path: "/health"
  swift_monitoring:
    build_status: "/api/swift/build/status"
    test_results: "/api/swift/tests"
    code_metrics: "/api/swift/metrics"
  opentelemetry:
    enabled: true
    endpoint: "http://localhost:4317"
  prometheus:
    enabled: true
    endpoint: "http://localhost:9090"
  grafana:
    enabled: true
    endpoint: "http://localhost:3001"
    credentials: "admin/admin"
  jaeger:
    enabled: true
    endpoint: "http://localhost:16686"
  loki:
    enabled: true
    endpoint: "http://localhost:3100"
  alertmanager:
    enabled: true
    endpoint: "http://localhost:9093"

# AI-assisted development settings
ai_development:
  code_review:
    enabled: true
    auto_suggest: true
    patterns:
      - "security"
      - "performance"
      - "best_practices"
  documentation:
    auto_update: true
    validate_references: true
    check_completeness: true
  testing:
    suggest_tests: true
    coverage_target: 80

# Project structure awareness
structure:
  swift_project:
    root: "./FilePilot"
    main_file: "./FilePilot/FilePilotApp.swift"
    project_config: "./project.yml"  # Single source of truth (XcodeGen)
    project_file: "./FilePilot.xcodeproj/project.pbxproj"  # Generated - DO NOT EDIT
    build_output: "~/Library/Developer/Xcode/DerivedData/FilePilot-*/Build/Products"
    task_config: "./.mise.toml"  # Task automation configuration
  typescript_project:
    root: "./agentic-workflow"
    main_file: "./agentic-workflow/src/index.ts"
    config: "./agentic-workflow/tsconfig.json"
    build_output: "./agentic-workflow/dist"

# Cross-reference system
cross_references:
  enabled: true
  index_file: "./docs/CROSS_REFERENCE_INDEX.json"
  auto_update: true
  check_broken_links: true

# Agent-specific behaviors
agent_behaviors:
  # CRITICAL: Check environment at session start
  startup_verification:
    required: true
    check_docker_running: true  # Docker commands use OrbStack (default context)
    check_mise_available: true  # Ensure mise is installed
    check_xcodegen_available: true  # Ensure XcodeGen is available
    verify_services_healthy: true
    query_initial_metrics: true
    fail_if_unhealthy: true
    container_runtime: "orbstack"  # Permanent default (2025-11-03)

    # Project synchronization (CRITICAL for modern workflow)
    sync_xcode_project: true  # Run mise project:sync at session start
    project_config_file: "./project.yml"

    # Context initialization
    load_context: true
    context_script: "./scripts/context-init.sh"
    required_files:
      - ".claude/SESSION_START.md"
      - "ARCHITECTURE_MAP.yaml"
      - ".claude/AGENTIC_STANDARDS.md"
      - "DOCUMENTATION_INDEX.md"
      - "project.yml"  # XcodeGen configuration
      - ".mise.toml"   # Task automation
      - "MODERN_SWIFT_WORKFLOW.md"  # Workflow guide

  # Development behaviors
  proactive_monitoring: true
  auto_fix_simple_issues: true
  suggest_improvements: true
  track_technical_debt: true
  maintain_documentation: true

  # Observability integration
  query_observability:
    before_changes: true
    check_build_status: true
    verify_test_coverage: true
    analyze_complexity: true
    review_recent_changes: true

  use_telemetry:
    for_code_review: true
    for_refactoring_decisions: true
    for_performance_analysis: true

# Validation rules
validation:
  documentation:
    require_headers: true
    max_section_depth: 4
    require_examples: true
    require_cross_references: true
  code:
    require_tests: true
    require_documentation: true
    security_checks: true
  commits:
    require_conventional: true
    require_issue_reference: false

# Development commands shortcuts
# Architectural Guardrails (UPDATED for modern workflow)
guardrails:
  # Read-only paths - agents cannot modify
  read_only:
    - "FilePilot.xcodeproj/**"  # GENERATED - Regenerate via: mise project:sync
    - "**/.xcodeproj/**"  # All Xcode project files are generated
    - ".git/**"  # Git internals
    - "node_modules/**"  # Dependencies
    - "**/*.lock"  # Lock files (package-lock.json, bun.lockb, etc.)
    - ".claude/context-summary.json"  # Generated file
    - "FilePilot/.build/**"  # Swift build artifacts
    - ".build/**"  # Swift build artifacts

  # Editable configuration (Project as Code)
  editable_configs:
    - "project.yml"  # XcodeGen configuration - THIS is editable
    - ".mise.toml"   # Task automation - THIS is editable
    - "Makefile"     # Command shortcuts - THIS is editable

  # Restricted paths with rules
  restricted:
    - path: "FilePilot/**"
      allowed_extensions: [".swift", ".entitlements", ".plist"]
      deny_extensions: [".pbxproj", ".xcworkspace"]
      reason: "Swift source files only, project files generated by XcodeGen"

    - path: "agentic-workflow/src/observability/**"
      required_keywords: ["OpenTelemetry", "trace", "span"]
      reason: "Observability code must use OpenTelemetry"

    - path: "agentic-workflow/observability/**"
      allowed_extensions: [".yaml", ".yml"]
      validation_command: "docker compose config -q"
      reason: "Compose files must be valid YAML"

    - path: "ARCHITECTURE_MAP.yaml"
      require_review: true
      must_update_timestamp: true
      reason: "Critical architectural document"

  # Required patterns in files
  mandatory_patterns:
    - pattern: "**/*.swift"
      must_include: ["import SwiftUI"]
      exceptions: ["**/Tests/**", "**/Package.swift"]

    - pattern: "agentic-workflow/src/features/**/routes.ts"
      must_include: ["express", "Router"]
      reason: "All route files must use Express Router"

  # Pre-commit validations
  pre_commit:
    - "Architecture map timestamp updated if ARCHITECTURE_MAP.yaml modified"
    - "Documentation cross-references validated"
    - "All TypeScript files formatted with Biome"
    - "All Swift files compile without errors"

commands:
  # Modern workflow commands (use these!)
  # CRITICAL: project_sync automatically cleans build artifacts to prevent stale cache issues
  project_sync: "mise project:sync"  # Regenerate Xcode project from project.yml + clean build cache
  project_validate: "mise project:validate"  # Validate project.yml
  swift_build: "mise build"  # Build app
  swift_build_release: "mise build:release"  # Build for release
  swift_build_clean: "mise build:clean"  # Clean build artifacts
  swift_test: "mise test"  # Run tests
  swift_test_coverage: "mise test:coverage"  # Run tests with coverage
  swift_run: "mise run"  # Build and run app
  dev_full: "mise dev"  # Start full dev environment
  agent_health: "mise agent:health"  # Check environment health
  agent_record: "mise agent:record"  # Record agent decision

  # Legacy direct commands (avoid using these - use mise instead)
  swift_build_direct: "xcodebuild build -project FilePilot.xcodeproj -scheme FilePilot"
  swift_test_direct: "xcodebuild test -project FilePilot.xcodeproj -scheme FilePilot"

  # TypeScript commands
  ts_dev: "cd agentic-workflow && bun run dev"
  ts_build: "cd agentic-workflow && bun run build"
  ts_format: "cd agentic-workflow && bun run format"
  ts_lint: "cd agentic-workflow && bun run lint"
  ts_check: "cd agentic-workflow && bun run check"

  # Context and observability
  context_init: "./scripts/context-init.sh"
  context_validate: "./scripts/context-init.sh --validate"
  observability_start: "mise observability:start"  # Use mise version
  observability_stop: "mise observability:stop"
  observability_logs: "mise observability:logs"

  # Make shortcuts
  help: "make help"  # Show all available commands

  # Note: All docker commands use OrbStack runtime (permanent default context)